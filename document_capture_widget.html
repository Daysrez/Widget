<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        #camera {
            width: 100%;
            height: 100%;
        }
        #target-box {
            width: 80%;
            height: 60%;
            border: 4px dashed #00FF00;
            position: absolute;
            top: 20%;
            left: 10%;
        }
        #canvas {
            display: none;
        }
        #preview {
            margin-top: 20px;
        }
        .preview-img {
            width: 100px;
            height: auto;
            margin: 10px;
            border: 2px solid #ccc;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="camera" autoplay></video>
        <div id="target-box"></div>
        <button id="capture-btn" style="display: none;">Capture Photo</button>
    </div>
    <canvas id="canvas"></canvas>

    <div id="preview">
        <h3>Preview Uploaded Photos</h3>
        <div id="preview-container"></div>
        <button id="submit-btn" style="display: none;">Submit Photos</button>
    </div>

    <script type="text/javascript">
        let video = document.getElementById('camera');
        let canvas = document.getElementById('canvas');
        let context = canvas.getContext('2d');
        let previewContainer = document.getElementById('preview-container');
        let captureBtn = document.getElementById('capture-btn');
        let submitBtn = document.getElementById('submit-btn');
        let images = [];

        // Start the camera when the widget is ready
        JFCustomWidget.subscribe("ready", function() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                }).catch(function(err) {
                    console.error("Camera access denied or not supported", err);
                    alert("Unable to access the camera. Please check your browser permissions.");
                });
            }
        });

        function isDocumentInBox() {
            // Placeholder logic to check if document is aligned
            return true;
        }

        function autoCapture() {
            if (isDocumentInBox()) {
                captureBtn.style.display = "block";
                captureBtn.removeEventListener('click', capturePhoto);  // Remove any existing listeners
                captureBtn.addEventListener('click', capturePhoto);     // Add new listener
            } else {
                requestAnimationFrame(autoCapture); // Keep checking
            }
        }

        function capturePhoto() {
            if (images.length >= 5) {  // Limit to 5 photos
                alert("You can only upload up to 5 photos.");
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imageData = canvas.toDataURL('image/png');
            images.push(imageData);
            updatePreview();
        }

        function updatePreview() {
            previewContainer.innerHTML = '';  // Clear existing previews
            images.forEach((img, idx) => {
                let imgElement = document.createElement('img');
                imgElement.src = img;
                imgElement.className = 'preview-img';
                imgElement.onclick = () => removeImage(idx);  // Click to remove image
                previewContainer.appendChild(imgElement);
            });

            submitBtn.style.display = images.length > 0 ? "block" : "none";  // Show submit button if there are images
        }

        function removeImage(index) {
            images.splice(index, 1);  // Remove the selected image
            updatePreview();  // Update the preview area
        }

        function submitPhotos() {
            // Send the images to JotForm as JSON
            JFCustomWidget.sendSubmit({
                valid: true,
                value: JSON.stringify(images)  // Send images as JSON
            });
        }

        // Start the auto-capture process
        autoCapture();

        // Submit button listener
        submitBtn.addEventListener('click', submitPhotos);
    </script>
</body>
</html>
